# 用户下单，订单支付

## 这里是基于一个外卖系统的用户下单的业务场景

**业务流程**：

1.商品首先放入购物车中，

2.在购物车中结算，

* 同时选择配送地址
* 完成订单支付
* ![image.png](/assets/249b5a8f-5744-498a-bbc5-d1ac292ffbb4.png)
* 清空购物车
* 跳转到下单成功界面
* ![image.png](/assets/11bbed50-6154-43e8-9c87-eca223c30b06.png)

3.这个订单就是发给商家的通知，以继产生相关的订单数据，就是平时看到的外卖单条

* 准备菜品准备发货

![image.png](/assets/45e92a24-c3ab-4353-a962-9f83ea6e0524.png)

## 订单数据库设计

![image.png](/assets/1fc1e66e-58b3-47ec-a6fe-46fe7a07db47.png)

### 订单表

这里面的订单状态，支付方式，支付状态都应该设置成静态的。

![image.png](/assets/a47ce0df-a8aa-4915-a2ee-b9a13293f914.png)

### 订单明细表

![image.png](/assets/531c470b-f40b-403b-99b5-ede4669931c5.png)

### 发送给前端的订单

![image.png](/assets/4f24eda6-d5ce-482e-a763-6c5faf9e3582.png)

## Service层的主要任务

**实现步骤**

--------判断:地址是否为空

--------判断:购物车是否为空

1.向订单插入一条数据

* 下面的订单明细他需要订单id，所以在编写xml映射文件时注意添加返回id的字段

2.向订单明细表中插入多条数据（因为是多个菜品）

* 这里用for循环插入

3.清空当前购物车

4.封装vo返回结果




# 微信付款功能


**微信支付的方式**：付款码支付，API支付，小程序，APP支付，刷脸支付，商家二维码支付。

**微信支付接入流程**：提交资料，签署协议，绑定场景



## JSAPI下单

商户系统调用该接口，在微信支付服务后台生成**预支付交易单**


![image.png](/assets/6cf5558d-4eb6-44d5-8f7e-d428d1c9049b.png)

### 商户端

访问网站看

![image.png](/assets/f0ec3192-1049-4c53-adff-d474f8129de3.png)

### 小程序端

![image.png](/assets/9d6950aa-3ec5-4018-b05e-074fcfab524a.png)



## 微信端访问服务器

现在，这个项目还只是在自己电脑上运行，微信服务器端访问不到http://localhost8080还处在局域网内,，这时就需要一个技术叫**内网穿透**，获取一个临时的域名

### 内网穿透

通过这个技术就能获取到一个映射访问地址，

**作用**：在内网和**公网**之间搭一个桥，

能让公网的服务器访问到这个商户服务器，这样微信服务器端就可以访问到商户服务器了

**实现步骤**：

1.**获取临时域名**：注册cpolar

2.**下载cpolar软件**

3.登录网站后：点击验证选项

4.复制该页面下的 ：Authtoken

5.**到软件执行命令的目录下**：打开cmd窗口

6.输入三部分信息，执行入口，authtoken，粘贴authtoken

![image.png](/assets/297273c0-280f-4698-b496-0f42b031742a.png)

7.**启动服务**：这个在网站上有步骤

也是输入两部分：执行命令，本地的服务器访问地址

![image.png](/assets/59ac1207-3b63-4f48-8556-e0c4bf267ed7.png)

8.**然后就可以通过获取到的域名进行访问了**：






## 微信支付实现步骤

1.**支付配置**

![image.png](/assets/d7e8428c-9cd3-413f-8ccd-dd7ec049072b.png)


2.**剩下的实现流程**：都用现成的代码
